{% extends "base.html" %}
{% block contenido %}

<div class="card-custom p-4">

    <h2 class="mb-4">Crear pedido #{{ pedido_id }}</h2>

    <form method="post" id="formPedido">
        {% csrf_token %}

        <!-- DATOS DEL CLIENTE: Cliente, Teléfono, Club -->
        <h5 class="section-title mb-3">Datos del cliente</h5>
        <div class="row mb-3">
            <div class="col-md-4">
                <label>Cliente *</label>
                <input type="text" name="Cliente" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label>Teléfono *</label>
                <input type="text" name="Telefono" class="form-control" pattern="[0-9]{9}" maxlength="9" required>
            </div>
            <div class="col-md-4">
                <label>Club</label>
                <input type="text" name="Club" class="form-control">
            </div>
        </div>

        <!-- FECHAS -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label>Fecha estimada de entrega</label>
                <input type="date" name="Fecha_entrega_estimada" class="form-control input-fecha-calendario">
            </div>
            <div class="col-md-6">
                <label>Fecha de entrada</label>
                <input type="date" name="Fecha_entrada" class="form-control" value="{{ fecha_hoy }}" readonly>
            </div>
        </div>

        <!-- COMENTARIOS -->
        <div class="mb-4">
            <label>Comentarios</label>
            <textarea name="Comentarios" class="form-control" rows="3" placeholder="Notas sobre lo hablado con el cliente..."></textarea>
        </div>

        <!-- ESTADOS -->
        <h5 class="section-title mb-2">Estados</h5>
        <div class="estados-box mb-4">

            <label>
                <input type="checkbox" name="Estados" value="Nuevo" class="estado-exclusivo"> Nuevo
            </label>

            <label>
                <input type="checkbox" name="Estados" value="diseño" class="estado-exclusivo"> diseño
            </label>

            <label>
                <input type="checkbox" name="Estados" value="fabricacion" class="estado-exclusivo"> fabricacion
            </label>

            <!-- ⭐ NUEVO ESTADO AÑADIDO ⭐ -->
            <label>
                <input type="checkbox" name="Estados" value="trabajo empezado"> trabajo empezado
            </label>

            <label>
                <input type="checkbox" name="Estados" value="pendiente"> pendiente
            </label>

            <label>
                <input type="checkbox" name="Estados" value="cobrado"> cobrado
            </label>

        </div>

        <!-- PRODUCTOS -->
        <h5 class="section-title mb-3">Productos</h5>

        <div id="productos-container">
            <div class="producto-item row g-2 mb-3">

                <div class="col-md-3">
                    <label>Producto</label>
                    <input list="lista_productos" name="producto_nombre_0" class="form-control">
                </div>

                <div class="col-md-3">
                    <label>Tejido</label>
                    <input list="lista_tejidos" name="producto_tejido_0" class="form-control">
                </div>

                <div class="col-md-2">
                    <label>Cantidad</label>
                    <input type="number" step="1" min="0" class="form-control" name="producto_cantidad_0">
                </div>

                <div class="col-md-2">
                    <label>Precio unitario</label>
                    <input type="number" step="0.01" min="0" class="form-control" name="producto_precio_0">
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger w-100" onclick="eliminarProducto(this)">Eliminar</button>
                </div>

            </div>
        </div>

        <button type="button" class="btn btn-secondary mb-4" onclick="agregarProducto()">Añadir producto</button>

        <datalist id="lista_productos">
            {% for pr in productos_disponibles %}
                <option value="{{ pr }}">
            {% endfor %}
        </datalist>

        <datalist id="lista_tejidos">
            {% for te in tejidos_disponibles %}
                <option value="{{ te }}">
            {% endfor %}
        </datalist>

        <!-- PRECIOS -->
        <h5 class="section-title mb-3">Precio</h5>

        <div class="row mb-3">
            <div class="col-md-4">
                <label>Precio total</label>
                <input type="number" step="0.01" name="Precio" class="form-control">
            </div>
            <div class="col-md-4">
                <label>Precio factura</label>
                <input type="number" step="0.01" name="Precio_factura" class="form-control">
            </div>
            <div class="col-md-4">
                <label>Forma de pago</label>
                <input type="text" name="Forma_pago" class="form-control">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label>Pago adelantado</label>
                <input type="number" step="0.01" name="Pago_adelantado" class="form-control">
            </div>
            <div class="col-md-6">
                <label>Destino total</label>
                <input type="text" name="DestinoTotal" class="form-control">
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Guardar pedido</button>

    </form>

</div>

<script>
let index = 1;

function agregarProducto() {
    let container = document.getElementById("productos-container");
    let html = `
    <div class="producto-item row g-2 mb-3">

        <div class="col-md-3">
            <label>Producto</label>
            <input list="lista_productos" name="producto_nombre_${index}" class="form-control">
        </div>

        <div class="col-md-3">
            <label>Tejido</label>
            <input list="lista_tejidos" name="producto_tejido_${index}" class="form-control">
        </div>

        <div class="col-md-2">
            <label>Cantidad</label>
            <input type="number" step="1" min="0" class="form-control" name="producto_cantidad_${index}">
        </div>

        <div class="col-md-2">
            <label>Precio unitario</label>
            <input type="number" step="0.01" min="0" class="form-control" name="producto_precio_${index}">
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-danger w-100" onclick="eliminarProducto(this)">Eliminar</button>
        </div>

    </div>
    `;
    container.insertAdjacentHTML("beforeend", html);
    index++;
}

function eliminarProducto(btn) {
    btn.closest(".producto-item").remove();
}
</script>

{% endblock %}
