{% extends "base.html" %}
{% block contenido %}

<div class="card-custom p-4">

    <h2 class="mb-4">Editar pedido #{{ pedido_id }}</h2>

    <form method="post" id="formPedido">
        {% csrf_token %}

        <!-- DATOS DEL CLIENTE -->
        <h5 class="section-title mb-3">Datos del cliente</h5>
        <div class="row mb-3">
            <div class="col-md-4">
                <label>Cliente *</label>
                <input type="text" name="Cliente" class="form-control" required value="{{ pedido.Cliente }}">
            </div>
            <div class="col-md-4">
                <label>Teléfono *</label>
                <input type="text" name="Telefono" class="form-control" pattern="[0-9]{9}" maxlength="9" required value="{{ pedido.Telefono }}">
            </div>
            <div class="col-md-4">
                <label>Club</label>
                <input type="text" name="Club" class="form-control" value="{{ pedido.Club }}">
            </div>
        </div>

        <!-- FECHAS -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label>Fecha estimada de entrega</label>
                <input type="date" name="Fecha_entrega_estimada" class="form-control input-fecha-calendario" value="{{ pedido.Fecha_entrega_estimada }}">
            </div>
            <div class="col-md-6">
                <label>Fecha de entrada</label>
                <input type="date" name="Fecha_entrada" class="form-control" value="{{ pedido.Fecha_entrada }}" readonly>
            </div>
        </div>

        <!-- COMENTARIOS -->
        <div class="mb-4">
            <label>Comentarios</label>
            <textarea name="Comentarios" class="form-control" rows="3" placeholder="Notas sobre lo hablado con el cliente...">{{ pedido.Comentarios }}</textarea>
        </div>

        <!-- ESTADOS -->
        <h5 class="section-title mb-2">Estados</h5>
        <div class="estados-box mb-4">
            <label>
                <input type="checkbox" name="Estados" value="Nuevo" class="estado-exclusivo"
                    {% if "Nuevo" in pedido.Estados %}checked{% endif %}> Nuevo
            </label>
            <label>
                <input type="checkbox" name="Estados" value="diseño" class="estado-exclusivo"
                    {% if "diseño" in pedido.Estados %}checked{% endif %}> diseño
            </label>
            <label>
                <input type="checkbox" name="Estados" value="fabricacion" class="estado-exclusivo"
                    {% if "fabricacion" in pedido.Estados %}checked{% endif %}> fabricacion
            </label>
            <label>
                <input type="checkbox" name="Estados" value="trabajo terminado" class="estado-exclusivo" id="estado-terminado"
                    {% if "trabajo terminado" in pedido.Estados %}checked{% endif %}> trabajo terminado
            </label>
            <label>
                <input type="checkbox" name="Estados" value="cobrado" id="estado-cobrado"
                    {% if "cobrado" in pedido.Estados %}checked{% endif %}> cobrado
            </label>
            <label>
                <input type="checkbox" name="Estados" value="retirado" id="estado-retirado"
                    {% if "retirado" in pedido.Estados %}checked{% endif %}> retirado
            </label>
            <label>
                <input type="checkbox" name="Estados" value="pendiente"
                    {% if "pendiente" in pedido.Estados %}checked{% endif %}> pendiente
            </label>
        </div>

        <!-- FECHA DE FINALIZACIÓN (CORREGIDO) -->
        <div id="fecha-finalizacion-container" class="row mb-3" style="display:none;">
            <div class="col-md-6">
                <label>Fecha de finalización</label>
                <input type="date" 
                       name="Fecha_finalizacion" 
                       class="form-control" 
                       value="{{ pedido.Fecha_finalizacion|date:'Y-m-d' }}" 
                       readonly>
            </div>
        </div>

        <!-- PRODUCTOS -->
        <h5 class="section-title mb-2">Productos</h5>

        <table class="table table-bordered table-detail">
            <colgroup>
                <col style="width:30%">
                <col style="width:20%">
                <col style="width:10%">
                <col style="width:15%">
                <col style="width:15%">
                <col style="width:10%">
            </colgroup>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Tejido</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="productos-tabla">
                <!-- Los productos se cargarán aquí vía JS -->
            </tbody>
        </table>

        <button type="button" class="btn btn-secondary mt-3" onclick="addProducto()">➕ Añadir producto</button>

        <!-- FACTURACIÓN Y PAGO -->
        <h5 class="section-title mt-4">Facturación</h5>
        <div class="row mb-3">
            <div class="col-md-6">
                <label>Precio</label>
                <input type="number" step="0.01" name="Precio" id="precioInput" class="form-control" value="{{ pedido.Precio|stringformat:'g' }}">
            </div>
            <div class="col-md-6">
                <label>Precio factura</label>
                <input type="number" step="0.01" name="Precio_factura" id="facturaInput" class="form-control" value="{{ pedido.Precio_factura|stringformat:'g' }}">
            </div>
        </div>

        <div class="row mt-3 align-items-end">
            <div class="col-md-4">
                <h4 class="total-pedido mb-0">
                    Total pedido: <span id="totalPedido">0.00€</span>
                </h4>
            </div>
            <div class="col-md-4">
                <label>Forma de pago</label>
                <select name="Forma_pago" class="form-select theme-select">
                    <option value="">— Seleccionar —</option>
                    <option value="transferencia" {% if pedido.Forma_pago == "transferencia" %}selected{% endif %}>Transferencia</option>
                    <option value="bizum" {% if pedido.Forma_pago == "bizum" %}selected{% endif %}>Bizum</option>
                    <option value="efectivo" {% if pedido.Forma_pago == "efectivo" %}selected{% endif %}>Efectivo</option>
                </select>
            </div>
            <div class="col-md-4">
                <label>Pago adelantado</label>
                <input type="number" step="0.01" name="Pago_adelantado" class="form-control" 
                       value="{{ pedido.Pago_adelantado|stringformat:'g' }}" placeholder="0.00">
            </div>
        </div>

        <div class="mt-3" style="max-width:260px;">
            <label class="fw-bold destino-label">Enviar total automáticamente a:</label>
            <select id="destinoTotal" name="DestinoTotal" class="form-select theme-select">
                <option value="">— No aplicar —</option>
                <option value="precio" {% if pedido.DestinoTotal == "precio" %}selected{% endif %}>Precio</option>
                <option value="precio_factura" {% if pedido.DestinoTotal == "precio_factura" %}selected{% endif %}>Precio factura</option>
            </select>
        </div>

        <!-- BOTONES -->
        <div class="mt-4 d-flex gap-2">
            <button class="btn btn-primary">Guardar</button>
            <a href="/pedidos/" class="btn btn-secondary">Cancelar</a>
        </div>

    </form>

    <!-- Plantillas ocultas -->
    <div id="plantilla-productos" style="display:none;">
        <select class="form-control">
            <option value="">— Seleccionar producto —</option>
            {% for prod in productos_disponibles %}
            <option value="{{ prod }}">{{ prod }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="plantilla-tejidos" style="display:none;">
        <select class="form-control">
            <option value="">— Seleccionar tejido —</option>
            {% for tejido in tejidos_disponibles %}
            <option value="{{ tejido }}">{{ tejido }}</option>
            {% endfor %}
        </select>
    </div>

</div>

<!-- ESTILOS, SCRIPTS Y LÓGICA (SIN CAMBIOS) -->
<style>
...
</style>

<script>
...
// Tu JS se mantiene igual
</script>

{% endblock %}
