{% extends "base.html" %}
{% block contenido %}

<div class="card-custom p-4">

    <h2 class="mb-4">Editar pedido #{{ pedido_id }}</h2>

    <form method="post" id="formPedido">
        {% csrf_token %}

        <!-- DATOS DEL CLIENTE -->
        <h5 class="section-title mb-3">Datos del cliente</h5>
        <div class="row mb-3">
            <div class="col-md-4">
                <label>Cliente *</label>
                <input type="text" name="Cliente" class="form-control" required value="{{ pedido.Cliente }}">
            </div>
            <div class="col-md-4">
                <label>Teléfono *</label>
                <input type="text" name="Telefono" class="form-control" pattern="[0-9]{9}" maxlength="9" required value="{{ pedido.Telefono }}">
            </div>
            <div class="col-md-4">
                <label>Club</label>
                <input type="text" name="Club" class="form-control" value="{{ pedido.Club }}">
            </div>
        </div>

        <!-- FECHAS -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label>Fecha estimada de entrega</label>
                <input type="date" name="Fecha_entrega_estimada" class="form-control" value="{{ pedido.Fecha_entrega_estimada }}">
            </div>
            <div class="col-md-6">
                <label>Fecha de entrada</label>
                <input type="date" name="Fecha_entrada" class="form-control" value="{{ pedido.Fecha_entrada }}" readonly>
            </div>
        </div>

        <!-- COMENTARIOS -->
        <div class="mb-4">
            <label>Comentarios</label>
            <textarea name="Comentarios" class="form-control" rows="3">{{ pedido.Comentarios }}</textarea>
        </div>

        <!-- ESTADOS -->
        <h5 class="section-title mb-2">Estados</h5>
        <div class="estados-box mb-4">

            <label><input type="checkbox" name="Estados" value="Nuevo"
                {% if "Nuevo" in pedido.Estados %}checked{% endif %}> Nuevo</label>

            <label><input type="checkbox" name="Estados" value="diseño"
                {% if "diseño" in pedido.Estados %}checked{% endif %}> diseño</label>

            <label><input type="checkbox" name="Estados" value="fabricacion"
                {% if "fabricacion" in pedido.Estados %}checked{% endif %}> fabricación</label>

            <label><input type="checkbox" name="Estados" value="trabajo terminado" id="estado-terminado"
                {% if "trabajo terminado" in pedido.Estados %}checked{% endif %}> trabajo terminado</label>

            <label><input type="checkbox" name="Estados" value="cobrado" id="estado-cobrado"
                {% if "cobrado" in pedido.Estados %}checked{% endif %}> cobrado</label>

            <label><input type="checkbox" name="Estados" value="retirado" id="estado-retirado"
                {% if "retirado" in pedido.Estados %}checked{% endif %}> retirado</label>

            <label><input type="checkbox" name="Estados" value="pendiente"
                {% if "pendiente" in pedido.Estados %}checked{% endif %}> pendiente</label>

        </div>

        <!-- FECHA FINALIZACIÓN -->
        <div id="fecha-finalizacion-container" class="row mb-3" style="display:none;">
            <div class="col-md-6">
                <label>Fecha de finalización</label>
                <input type="date"
                       name="Fecha_finalizacion"
                       class="form-control"
                       value="{{ pedido.Fecha_finalizacion|date:'Y-m-d' }}"
                       readonly>
            </div>
        </div>

        <!-- PRODUCTOS -->
        <h5 class="section-title mb-2">Productos</h5>

        <table class="table table-bordered table-detail">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Tejido</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="productos-tabla"></tbody>
        </table>

        <button type="button" class="btn btn-secondary mt-3" onclick="addProducto()">➕ Añadir producto</button>

        <!-- FACTURACIÓN -->
        <h5 class="section-title mt-4">Facturación</h5>
        <div class="row mb-3">
            <div class="col-md-6">
                <label>Precio</label>
                <input type="number" step="0.01" name="Precio" id="precioInput" class="form-control" value="{{ pedido.Precio }}">
            </div>
            <div class="col-md-6">
                <label>Precio factura</label>
                <input type="number" step="0.01" name="Precio_factura" id="facturaInput" class="form-control" value="{{ pedido.Precio_factura }}">
            </div>
        </div>

        <div class="row mt-3 align-items-end">
            <div class="col-md-4">
                <h4 class="total-pedido mb-0">
                    Total pedido: <span id="totalPedido">0.00€</span>
                </h4>
            </div>

            <div class="col-md-4">
                <label>Forma de pago</label>
                <select name="Forma_pago" class="form-select">
                    <option value="">— Seleccionar —</option>
                    <option value="transferencia" {% if pedido.Forma_pago == "transferencia" %}selected{% endif %}>Transferencia</option>
                    <option value="bizum" {% if pedido.Forma_pago == "bizum" %}selected{% endif %}>Bizum</option>
                    <option value="efectivo" {% if pedido.Forma_pago == "efectivo" %}selected{% endif %}>Efectivo</option>
                </select>
            </div>

            <div class="col-md-4">
                <label>Pago adelantado</label>
                <input type="number" step="0.01" name="Pago_adelantado" class="form-control" value="{{ pedido.Pago_adelantado }}">
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button class="btn btn-primary">Guardar</button>
            <a href="/pedidos/" class="btn btn-secondary">Cancelar</a>
        </div>

    </form>

</div>

<script>
/* ================================
   PRODUCTOS: carga y cálculo
================================ */
const productosIniciales = {{ productos|safe }};
let globalIndex = 0;

function addProducto(producto = null) {
    const table = document.getElementById("productos-tabla");
    const row = document.createElement("tr");
    row.classList.add("producto-item");

    const index = globalIndex++;

    row.innerHTML = `
        <td>
            <select name="temp_producto_nombre_${index}" class="form-control">
                <option value="">— Seleccionar —</option>
                {% for prod in productos_disponibles %}
                <option value="{{ prod }}">{{ prod }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="temp_producto_tejido_${index}" class="form-control">
                <option value="">— Seleccionar —</option>
                {% for tejido in tejidos_disponibles %}
                <option value="{{ tejido }}">{{ tejido }}</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="number" name="temp_producto_cantidad_${index}" class="form-control cantidad" value="${producto?.cantidad ?? 1}"></td>
        <td><input type="number" name="temp_producto_precio_${index}" class="form-control precio" value="${producto?.precio_unitario ?? 0}"></td>
        <td><input class="form-control subtotal" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcularTotales();">X</button></td>
    `;

    table.appendChild(row);
    if (producto) {
        row.querySelector(`select[name="temp_producto_nombre_${index}"]`).value = producto.Producto;
        row.querySelector(`select[name="temp_producto_tejido_${index}"]`).value = producto.tejido;
    }
    calcularTotales();
}

function calcularTotales() {
    let total = 0;
    document.querySelectorAll(".producto-item").forEach(row => {
        const cant = parseFloat(row.querySelector(".cantidad").value) || 0;
        const precio = parseFloat(row.querySelector(".precio").value) || 0;
        const sub = cant * precio;
        row.querySelector(".subtotal").value = sub.toFixed(2);
        total += sub;
    });
    document.getElementById("totalPedido").innerText = total.toFixed(2) + "€";
}

/* ================================
   ESTADOS + FECHA FINALIZACIÓN
================================ */
function validarEstados() {
    const terminado = document.getElementById("estado-terminado");
    const cobrado = document.getElementById("estado-cobrado");
    const retirado = document.getElementById("estado-retirado");

    const cont = document.getElementById("fecha-finalizacion-container");

    if (terminado.checked && cobrado.checked && retirado.checked) {
        cont.style.display = "block";
    } else {
        cont.style.display = "none";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    productosIniciales.forEach(p => addProducto(p));
    calcularTotales();
    validarEstados();

    document.querySelectorAll("input[name='Estados']").forEach(chk => {
        chk.addEventListener("change", validarEstados);
    });
});

/* ================================
   RENOMBRAR CAMPOS ANTES DE ENVIAR
================================ */
document.getElementById("formPedido").addEventListener("submit", () => {
    document.querySelectorAll("#productos-tabla .producto-item").forEach((row, i) => {
        row.querySelectorAll("select, input").forEach(inp => {
            inp.name = inp.name.replace(/temp_producto_[a-z]+_\d+/, match => {
                const part = match.split("_")[1];
                return `producto_${part}_${i}`;
            });
        });
    });
});
</script>

{% endblock %}
