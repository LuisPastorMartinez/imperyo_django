{% extends "base.html" %}
{% block contenido %}

<div class="card-custom p-4">

    <!-- MenÃº de navegaciÃ³n (SIN "Resumen") -->
    <nav class="navbar-nav-horizontal mb-4">
        <a href="{% url 'pedidos_home' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos_home' %}active{% endif %}">Inicio</a>
        <a href="{% url 'posibles_clientes' %}" class="nav-item {% if request.resolver_match.url_name == 'posibles_clientes' %}active{% endif %}">Posibles clientes</a>
        <a href="{% url 'gastos' %}" class="nav-item {% if request.resolver_match.url_name == 'gastos' %}active{% endif %}">Gastos</a>
        <a href="{% url 'configuracion' %}" class="nav-item {% if request.resolver_match.url_name == 'configuracion' %}active{% endif %}">ConfiguraciÃ³n</a>
    </nav>

    <h2 class="mb-4">ðŸ“‹ Resumen de pedidos ({{ pedidos|length }})</h2>

    <!-- Filtros -->
    <div class="card-custom mb-4 p-3">
        <div class="row g-3">
            <!-- Filtro por estados -->
            <div class="col-md-6">
                <label class="form-label">Filtrar por estado:</label>
                <div>
                    {% for estado in estados_todos %}
                    <label class="me-3">
                        <input type="checkbox" class="filtro-estado" value="{{ estado }}">
                        {{ estado }}
                    </label>
                    {% endfor %}
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="resetEstados()">â†º Limpiar</button>
                </div>
            </div>

            <!-- Filtro por club o telÃ©fono -->
            <div class="col-md-3">
                <label class="form-label">Club contiene:</label>
                <input type="text" id="filtro-club" class="form-control form-control-sm" placeholder="Ej: Tenerife">
            </div>
            <div class="col-md-3">
                <label class="form-label">TelÃ©fono contiene:</label>
                <input type="text" id="filtro-telefono" class="form-control form-control-sm" placeholder="Ej: 666">
            </div>
        </div>
    </div>

    {% if pedidos %}
    <div class="table-responsive">
        <table class="table-home table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Club</th>
                    <th>Cliente</th>
                    <th>TelÃ©fono</th>
                    <th>Productos</th>
                    <th>Precio</th>
                    <th>Precio factura</th>
                    <th>Entrada</th>
                    <th>Estimada</th>
                    <th>Salida</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pedidos %}
                <tr data-estados='{{ p.Estados_json|safe }}'>
                    <td><strong>{{ p.ID }}</strong></td>
                    <td>{{ p.Club }}</td>
                    <td>{{ p.Cliente }}</td>
                    <td>{{ p.Telefono }}</td>
                    <td>
                        {% if p.productos %}
                            {{ p.productos|length }} productos
                        {% else %}
                            â€”
                        {% endif %}
                    </td>
                    <td>{{ p.Precio|default:"â€”" }}</td>
                    <td>{{ p.Precio_factura|default:"â€”" }}</td>
                    <td>{{ p.Fecha_entrada|default:"â€”" }}</td>
                    <td>{{ p.Fecha_entrega_estimada|default:"â€”" }}</td>
                    <td>{{ p.Fecha_finalizacion|default:"â€”" }}</td>
                    <td class="estado-iconos">
                        {{ p.Estados_iconos|safe }}
                    </td>
                    <td class="acciones">
                        <a href="{% url 'pedido_detalle' p.ID %}" class="btn btn-info btn-sm">Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="alert alert-secondary">
        No hay pedidos.
    </div>
    {% endif %}

</div>

<script>
function aplicarFiltros() {
    const filtroClub = document.getElementById('filtro-club').value.toLowerCase().trim();
    const filtroTelefono = document.getElementById('filtro-telefono').value.toLowerCase().trim();
    const estadosSeleccionados = Array.from(document.querySelectorAll('.filtro-estado:checked'))
                                   .map(cb => cb.value);

    document.querySelectorAll('.table-home tbody tr').forEach(fila => {
        const club = (fila.cells[1]?.textContent || '').toLowerCase();
        const telefono = (fila.cells[3]?.textContent || '').toLowerCase();
        const estadosPedido = JSON.parse(fila.getAttribute('data-estados') || '[]');

        const coincideClub = !filtroClub || club.includes(filtroClub);
        const coincideTelefono = !filtroTelefono || telefono.includes(filtroTelefono);
        let coincideEstado = true;

        if (estadosSeleccionados.length > 0) {
            coincideEstado = estadosSeleccionados.some(e => estadosPedido.includes(e));
        }

        fila.style.display = (coincideClub && coincideTelefono && coincideEstado) ? '' : 'none';
    });
}

function resetEstados() {
    document.querySelectorAll('.filtro-estado').forEach(cb => cb.checked = false);
    aplicarFiltros();
}

// Inicializar eventos
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('filtro-club')?.addEventListener('input', aplicarFiltros);
    document.getElementById('filtro-telefono')?.addEventListener('input', aplicarFiltros);
    document.querySelectorAll('.filtro-estado').forEach(cb => {
        cb.addEventListener('change', aplicarFiltros);
    });
});
</script>

{% endblock %}