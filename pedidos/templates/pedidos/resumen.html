{% extends "base.html" %}
{% block contenido %}

<!-- Men√∫ de navegaci√≥n -->
<nav class="navbar-nav-horizontal mb-4">
    {% if request.resolver_match.url_name != 'pedidos_home' %}
    <a href="{% url 'pedidos_home' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos_home' %}active{% endif %}">üè† Inicio</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'agenda' %}
    <a href="{% url 'agenda' %}" class="nav-item {% if request.resolver_match.url_name == 'agenda' %}active{% endif %}">üìÖ Agenda</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'posibles_clientes' %}
    <a href="{% url 'posibles_clientes' %}" class="nav-item {% if request.resolver_match.url_name == 'posibles_clientes' %}active{% endif %}">üë• Posibles clientes</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'gastos' %}
    <a href="{% url 'gastos' %}" class="nav-item {% if request.resolver_match.url_name == 'gastos' %}active{% endif %}">üí∞ Gastos</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'configuracion' %}
    <a href="{% url 'configuracion' %}" class="nav-item {% if request.resolver_match.url_name == 'configuracion' %}active{% endif %}">‚öôÔ∏è Configuraci√≥n</a>
    {% endif %}
</nav>

<h2>üìã Resumen de pedidos ({{ pedidos|length }})</h2>

<div class="card-custom mb-4">
    <h5 class="section-title mb-3">Filtros</h5>
    
    <div class="mb-3">
        <strong>Filtrar por estado:</strong>
        {% for estado in estados_todos %}
            <button class="btn btn-sm btn-outline-secondary" onclick="filtrarPorEstado('{{ estado }}')">
                {{ estado }}
            </button>
        {% endfor %}
        <button class="btn btn-sm btn-outline-secondary" onclick="limpiarFiltros()">‚Ü∫ Limpiar</button>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label>Club contiene:</label>
            <input type="text" id="filtro-club" class="form-control" onkeyup="filtrarTabla()">
        </div>
        <div class="col-md-6 mb-3">
            <label>Tel√©fono contiene:</label>
            <input type="text" id="filtro-telefono" class="form-control" onkeyup="filtrarTabla()">
        </div>
    </div>
</div>

{% if pedidos %}
<table class="table-home table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Club</th>
            <th>Cliente</th>
            <th>Tel√©fono</th>
            <th>Productos</th>
            <th>Precio</th>
            <th>Precio factura</th>
            <th>Entrada</th>
            <th>Estimada</th>
            <th>Salida</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="tabla-pedidos-body">
        {% for p in pedidos %}
        <tr>
            <td>{{ p.ID }}</td>
            <td>{{ p.Club }}</td>
            <td>{{ p.Cliente }}</td>
            <td>{{ p.Telefono }}</td>
            <td>
                {% if p.productos %}
                    {{ p.productos|length }} productos
                {% else %}
                    ‚Äî
                {% endif %}
            </td>
            <td>{{ p.Precio|default:"‚Äî" }}</td>
            <td>{{ p.Precio_factura|default:"‚Äî" }}</td>
            <td>{{ p.Fecha_entrada|default:"‚Äî" }}</td>
            <td>{{ p.Fecha_entrega_estimada|default:"‚Äî" }}</td>
            <td>{{ p.Fecha_finalizacion|default:"‚Äî" }}</td>
            <td>{{ p.Estados_iconos|safe }}</td>
            <td>
                <a href="{% url 'pedido_detalle' p.ID %}" class="btn btn-sm btn-info">Ver</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="card-custom">
    <p>No hay pedidos.</p>
</div>
{% endif %}

<script>
function filtrarPorEstado(estado) {
    const rows = document.querySelectorAll('#tabla-pedidos-body tr');
    rows.forEach(row => {
        const estadosJson = row.querySelector('td:nth-child(11)').dataset.estados;
        const estados = JSON.parse(estadosJson || '[]');
        row.style.display = estados.includes(estado) ? '' : 'none';
    });
}

function limpiarFiltros() {
    document.getElementById('filtro-club').value = '';
    document.getElementById('filtro-telefono').value = '';
    const rows = document.querySelectorAll('#tabla-pedidos-body tr');
    rows.forEach(row => row.style.display = '');
}

function filtrarTabla() {
    const club = document.getElementById('filtro-club').value.toLowerCase();
    const telefono = document.getElementById('filtro-telefono').value.toLowerCase();
    const rows = document.querySelectorAll('#tabla-pedidos-body tr');
    
    rows.forEach(row => {
        const clubCell = row.cells[1].textContent.toLowerCase();
        const telCell = row.cells[3].textContent.toLowerCase();
        
        const mostrar = (!club || clubCell.includes(club)) && 
                        (!telefono || telCell.includes(telefono));
        row.style.display = mostrar ? '' : 'none';
    });
}
</script>

{% endblock %}