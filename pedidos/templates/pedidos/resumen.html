{% extends "base.html" %}
{% block contenido %}

    {% if request.resolver_match.url_name != 'pedidos_home' %}
    <a href="{% url 'pedidos_home' %}">üè† Inicio</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'agenda' %}
    <a href="{% url 'agenda' %}">üìÖ Agenda</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'posibles_clientes' %}
    <a href="{% url 'posibles_clientes' %}">üë• Posibles clientes</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'gastos' %}
    <a href="{% url 'gastos' %}">üí∞ Gastos</a>
    {% endif %}
    {% if request.resolver_match.url_name != 'configuracion' %}
    <a href="{% url 'configuracion' %}">‚öôÔ∏è Configuraci√≥n</a>
    {% endif %}

<h1>üìã Resumen de pedidos ({{ pedidos|length }})</h1>

<div class="filtros-contenedor">
    <h2>üîç Filtros</h2>
    
    <div class="filtro-seccion">
        <strong>Filtrar por estado:</strong>
        {% for estado in estados_todos %}
        <label class="checkbox-estado">
            <input 
                type="checkbox" 
                name="filtro_estado" 
                value="{{ estado }}"
                class="filtro-checkbox"
            >
            {{ estado }}
        </label>
        {% endfor %}
        <button onclick="limpiarFiltros()" class="btn-limpiar">‚Ü∫ Limpiar</button>
    </div>
    
    <div class="filtro-seccion">
        <label>
            <strong>Club contiene:</strong>
            <input type="text" id="filtro_club" placeholder="Ej: Amigos de la tercera edad" class="filtro-input">
        </label>
        
        <label>
            <strong>Tel√©fono contiene:</strong>
            <input type="text" id="filtro_telefono" placeholder="Ej: 612" class="filtro-input">
        </label>
    </div>
</div>

{% if pedidos %}
<table class="tabla-pedidos">
    <thead>
        <tr>
            <th>ID</th>
            <th>Club</th>
            <th>Cliente</th>
            <th>Tel√©fono</th>
            <th>Productos</th>
            <th>Precio</th>
            <th>Precio factura</th>
            <th>Entrada</th>
            <th>Estimada</th>
            <th>Salida</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for p in pedidos %}
        <tr data-estados='{{ p.Estados_json|safe }}'>
            <td>{{ p.ID }}</td>
            <td>{{ p.Club }}</td>
            <td>{{ p.Cliente }}</td>
            <td>{{ p.Telefono }}</td>
            <td>
                {% if p.productos %}
                    {{ p.productos|length }} productos
                {% else %}
                    ‚Äî
                {% endif %}
            </td>
            <td>{{ p.Precio|default:"‚Äî" }}</td>
            <td>{{ p.Precio_factura|default:"‚Äî" }}</td>
            <td>{{ p.Fecha_entrada|default:"‚Äî" }}</td>
            <td>{{ p.Fecha_entrega_estimada|default:"‚Äî" }}</td>
            <td>{{ p.Fecha_finalizacion|default:"‚Äî" }}</td>
            <td>{{ p.Estados_iconos|safe }}</td>
            <td>
                <a href="{% url 'pedido_detalle' p.ID %}">Ver</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No hay pedidos.</p>
{% endif %}

<style>
.filtros-contenedor {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.filtro-seccion {
    margin: 10px 0;
}

.filtro-seccion label {
    display: inline-block;
    margin-right: 15px;
    margin-bottom: 8px;
}

.checkbox-estado {
    display: inline-block;
    margin-right: 10px;
    margin-bottom: 8px;
    padding: 5px 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
}

.checkbox-estado input[type="checkbox"] {
    margin-right: 5px;
}

.filtro-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-left: 10px;
    width: 250px;
}

.btn-limpiar {
    background: #ff4444;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 15px;
    font-weight: bold;
}

.btn-limpiar:hover {
    background: #cc0000;
}

.tabla-pedidos {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.tabla-pedidos th,
.tabla-pedidos td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}

.tabla-pedidos th {
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
}

.tabla-pedidos tr:nth-child(even) {
    background-color: #f9f9f9;
}

.tabla-pedidos tr:hover {
    background-color: #f0f0f0;
}

.tabla-pedidos a {
    color: #2196F3;
    text-decoration: none;
}

.tabla-pedidos a:hover {
    text-decoration: underline;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1Ô∏è‚É£ FILTRO POR ESTADOS (checkboxes)
    const estadoCheckboxes = document.querySelectorAll('.filtro-checkbox');
    estadoCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', aplicarFiltros);
    });
    
    // 2Ô∏è‚É£ FILTRO POR CLUB (input de texto)
    const filtroClub = document.getElementById('filtro_club');
    if (filtroClub) {
        filtroClub.addEventListener('input', aplicarFiltros);
    }
    
    // 3Ô∏è‚É£ FILTRO POR TEL√âFONO (input de texto)
    const filtroTelefono = document.getElementById('filtro_telefono');
    if (filtroTelefono) {
        filtroTelefono.addEventListener('input', aplicarFiltros);
    }
    
    // ‚úÖ APLICAR FILTROS
    function aplicarFiltros() {
        const estadosSeleccionados = Array.from(estadoCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value.trim());
        
        const clubBuscar = filtroClub ? filtroClub.value.toLowerCase().trim() : '';
        const telefonoBuscar = filtroTelefono ? filtroTelefono.value.toLowerCase().trim() : '';
        
        const filas = document.querySelectorAll('table tbody tr');
        
        filas.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            if (celdas.length < 11) return;
            
            // Extraer datos de la fila
            const club = celdas[1].textContent.toLowerCase().trim();
            const telefono = celdas[3].textContent.toLowerCase().trim();
            const estadosJson = fila.getAttribute('data-estados');
            
            let mostrar = true;
            
            // üîπ Filtro por estados
            if (estadosSeleccionados.length > 0 && estadosJson) {
                try {
                    const estadosFila = JSON.parse(estadosJson);
                    const tieneAlgunEstado = estadosSeleccionados.some(est => 
                        estadosFila.includes(est.trim())
                    );
                    if (!tieneAlgunEstado) mostrar = false;
                } catch (e) {
                    console.error('Error parseando estados:', e);
                }
            }
            
            // üîπ Filtro por club
            if (clubBuscar && !club.includes(clubBuscar)) {
                mostrar = false;
            }
            
            // üîπ Filtro por tel√©fono
            if (telefonoBuscar && !telefono.includes(telefonoBuscar)) {
                mostrar = false;
            }
            
            fila.style.display = mostrar ? '' : 'none';
        });
    }
    
    // üßπ LIMPIAR FILTROS
    window.limpiarFiltros = function() {
        estadoCheckboxes.forEach(cb => cb.checked = false);
        if (filtroClub) filtroClub.value = '';
        if (filtroTelefono) filtroTelefono.value = '';
        aplicarFiltros();
    };
    
    // üéØ APLICAR FILTROS INICIALMENTE
    aplicarFiltros();
});
</script>

{% endblock %}